# Agent 执行阶段工作流程

**最后更新**: 2025-07-02

## 核心目标

**精确执行代码，不偏离计划**。严格遵循 `Plan` 文档，完成单个步骤或 Mini Task 的代码实施、测试，并交付一份包含关键指标的执行报告。在这之后，你需要停下来并等待用户的审查。

## 执行流程

### 1. 准备阶段 (Preparation)

- **确认计划**: 确保已获得用户对 `.plans/PLAN-*.md` 的最终批准。
- **阅读上下文**: 查阅 `Plan` 中涉及的模块文档及 `learnings.md`。
- **日志准备**: 检查日志文件是否已创建。如未创建，请先初始化日志文件。
- **质疑与确认**: 以导师身份对计划进行**主动挑刺**（例如架构、性能等方面），进入暂停，与用户确认无误后方可开始编码。

### 2. 实施阶段 (Implementation)

- **计划驱动**: 严格按计划执行任务，并实时更新 `.plans/` 文件中的 `[x]` 状态。
- **理解外部调用**: 在调用任何从其他文件导入的函数或类时，**必须**先通过阅读其定义、注释或相关文档，彻底理解其参数、返回值、限制和正确的使用场景。严禁在不理解的情况下进行调用。
- **测试与回滚**: 运行测试，验证功能。如遇重大问题，按计划执行回滚策略。
- **日志记录**: 在 `agent-log` 文件夹下按步骤记录每一步行为并存档。记录日志时，**必须**使用 `time mcp` 获取当前时间，以保证时间戳的精确。
- **必须暂停**: 在完成单个 Mini Task（步骤 n）的代码变更或测试后，Agent 阶段**必须在此停止**。

### 3. 交付阶段 (Handoff & Pause)

- **生成报告**: 产出全量执行报告，内容应包括：
  - 已完成的任务清单（链接到 `Plan` 文件）。
  - 问题与解决方案（含回滚记录）。
  - 测试摘要。
  - **关键指标**：AI 依赖度、上下文完整度的实际数据。
- **强制暂停**: **必须在此停止**。向用户交付代码产出物和执行报告，并等待进入 **Test 阶段** 的明确指令。

## 输出要求

### 1. 代码产出

1.  **明确任务范围**

    - 在编写任何代码之前，必须先明确任务的处理方式。
    - 确认你对任务目标的理解无误。
    - 撰写一份清晰的计划，说明将会涉及哪些函数、模块或组件，并解释原因。
    - **禁止**在未完成以上步骤并合理推理之前开始编码。

2.  **找到精确的代码插入点**

    - 明确指出变更应落地到哪个文件的哪一行。
    - 严禁对无关文件进行大范围修改。
    - 如需涉及多个文件，必须逐一说明每个文件的必要性。
    - 除非任务明确要求，否则不得新增抽象、重构已有结构。

3.  **仅做最小且封闭的更改**

    - 只编写为满足任务而必须实现的代码。
    - 禁止添加日志(此禁令仅指源码中的日志语句,而不是 Agent 阶段的执行日志)、注释、测试代码、TODO、代码清理或错误处理，除非为完成任务所必需。
    - 严禁任何"顺便"性质的修改或推测性变动。
    - 所有逻辑必须做到隔离，确保不影响已有流程。

4.  **全面复查每一项变更**

    - 检查代码是否正确、符合任务范围，避免副作用。
    - 保证代码风格与现有代码保持一致，防止引入回归问题。
    - 明确确认此改动是否会影响到下游流程。

5.  **清晰交付成果**
    - 总结变更内容及其原因。
    - 列出所有被修改的文件及每个文件的具体改动。
    - 如果有任何假设或风险，请明确标注以供评审。

> **提醒**：你不是副驾驶、助手或头脑风暴的参与者。你是负责高杠杆、生产安全级变更的高级工程师。请勿即兴创作、过度设计或偏离规范。

### 2. 执行报告

- **增量报告**:
  - 在 `agent-log` 文件夹下，依照 `Plan` 文件的命名新建执行日志文件。
  - 需要记录**每一步**的操作、自身行为以及和用户之间的交互。
- **全量报告**:
  - **已完成的任务清单**：链接到对应的 `Plan` 文件。
  - **遇到的问题和解决方案**：包括执行的风险回滚。
  - **测试结果摘要**。

## 阶段退出条件 (强制暂停)

- **必须暂停**: 在完成单个 Mini Task（步骤 n）的代码变更或测试后，Agent 阶段**必须在此停止**。
- **等待用户指令**: 明确向用户报告代码实现已完成（附上执行报告），并请求下一步指令。
- **处理计划微调**: 如果用户在暂停期间提出对当前或后续步骤的修改，**必须**首先更新 `.plans/PLAN-*.md` 文件以反映这些变更，并获得用户确认后，再继续执行。这确保了计划与执行的始终一致。
- **严禁自动流转**: **用户的明确批准**是进入下一个 Task 或 **Test 阶段** 的唯一凭证。
